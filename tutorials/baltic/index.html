<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8"/>
	<title>baltic/</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- RSS feed -->
	<link rel="alternate" type="application/rss+xml" title="Bedford Lab Research" href="http://laduplessis.github.io//feed.xml">
	
    <!-- Customized Bootstrap + Font Awesome + Solarized -->
    <link href="/blotter/css/style.css" rel="stylesheet" media="screen">

	<!-- Favicon -->
	<link rel="shortcut icon" href="/blotter/images/favicon.png"/>	

	<!-- Typekit -->
	<script>
	  (function(d) {
		var config = {
		  kitId: 'xeu8jut',
		  scriptTimeout: 3000
		},
		h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='//use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
	  })(document);
	</script>
		
	<!-- Google Analytics -->	
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-26244371-2', 'laduplessis.github.io/Taming_the_BEAST_blotter');
		ga('send', 'pageview');

	</script>
	
	<!-- jQuery -->
	<script src="/blotter/js/jquery.min.js"></script>
	
	<!-- Bootstrap -->
	<script src="/blotter/js/transition.js"></script>
	<script src="/blotter/js/collapse.js"></script>

</head>

<body>
	
	<div id="header">
	<nav class="navbar navbar-default navbar-static-top" role="navigation">	 
		<div class="container">	

			<div class="navbar-header">
				<!--button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-element" aria-expanded="false">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button-->
									
				<a class="navbar-brand" href="/blotter/">Taming the BEAST</a>
				<object class="logo navbar-brand" data="/blotter/images/logo_bw.svg" type="image/svg+xml"></object>
				
			</div>

			<div class="collapse navbar-collapse" id="navbar-collapse-element">
				<ul class="nav navbar-nav navbar-right">					
					
					<li>
					
					<a href="/blotter/news/">news</a>
					</li>
					
					<li>
					
					<a href="/blotter/tutorials/">tutorials</a></li>	    	  
				</ul>
			</div>
			
		</div>
	</nav>	
</div>
	
	<div class="container">	
		
	

<div class="row">
	<div class="col-md-12">
		<div class="bigtitle titlebox">
			<ol class="breadcrumb">
			
			
				
				
				
				<li>baltic</li>
				
			
			</ol>
		</div>
		<p>
		<div class="head">
			BALTIC - adaptable lightweight tree import code for molecular phylogeny manipulation, analysis and visualisation
		</div>
	</div>				
</div>

<div class="bigspacer"></div>

<div class="row">
	<div class="col-md-3">
		<div class="bigspacer"></div>
		<div class="smallhead">
			Source code
		</div>	
		<div class="pad-left note">
			<div class="smallspacer"></div>
			<i class="fa fa-cog fa-fw"></i>
			<a class="off" href="https://github.com/blab/baltic">github.com/blab/baltic</a>
		</div>
		<div class="bigspacer"></div>
		<div class="smallhead">
			Contributors
		</div>	
		<div class="pad-left note">
				
			<div class="smallspacer"></div>				
			<div>
				<a class="off" href="https://github.com/evogytis">
    			<img class="pull-left avatar" src="https://avatars.githubusercontent.com/u/1536822?v=3&s=50">
    			<div class="handlebox" style="padding-left:5px;">
    				evogytis
    			</div>
 				</a>
 			</div>			
 				
			<div class="smallspacer"></div>				
			<div>
				<a class="off" href="https://github.com/trvrb">
    			<img class="pull-left avatar" src="https://avatars.githubusercontent.com/u/1176109?v=3&s=50">
    			<div class="handlebox" style="padding-left:5px;">
    				trvrb
    			</div>
 				</a>
 			</div>			
 			
		</div>
		<div class="bigspacer"></div>
		<div class="smallhead">
			Latest commits
		</div>		
		<div class="pad-left smallnote">
			<ul class="list-unstyled">
			
				<div class="smallspacer"></div>
				<li> 
					<i class="fa fa-check-square-o fa-fw"></i>
					<a class="off" href="https://github.com/blab/baltic/commit/d1a16c43c3b7b1419bc9a9756fe57a87263ec794">
					20 Aug 2016 - <span class="text-gray">Add links to readme.</span>
					</a> 
				</li>
			
				<div class="smallspacer"></div>
				<li> 
					<i class="fa fa-check-square-o fa-fw"></i>
					<a class="off" href="https://github.com/blab/baltic/commit/83e1115bf8019558b7fec4bc2ec4648c183bdd46">
					06 Aug 2016 - <span class="text-gray">Update basic documentation of baltic.</span>
					</a> 
				</li>
			
				<div class="smallspacer"></div>
				<li> 
					<i class="fa fa-check-square-o fa-fw"></i>
					<a class="off" href="https://github.com/blab/baltic/commit/40613deaf034c06f8c94747e19e52b6f85c757b3">
					23 Jul 2016 - <span class="text-gray">fix pretentious read</span>
					</a> 
				</li>
			
				<div class="smallspacer"></div>
				<li> 
					<i class="fa fa-check-square-o fa-fw"></i>
					<a class="off" href="https://github.com/blab/baltic/commit/acfaf6470718d39089a84351c16a0fd824db092d">
					23 Jul 2016 - <span class="text-gray">Major overhaul of baltic organisation.</span>
					</a> 
				</li>
			
				<div class="smallspacer"></div>
				<li> 
					<i class="fa fa-check-square-o fa-fw"></i>
					<a class="off" href="https://github.com/blab/baltic/commit/a4c4ee9b588aa470209463391ba8a6e4aec98749">
					22 Jul 2016 - <span class="text-gray">Merge pull request #1 from blab/readme

Include readme</span>
					</a> 
				</li>
			
			</ul>
		</div>		
		<div class="spacer"></div>	
		
					
			
					
			
					
			
					
			
					
			
					
			
					
			
					
			
					
			
					
			
					
			
					
			
			<!-- 4 -->
			
					
			
					
			
					
			
		
				
		
		<div class="smallhead">
			Pages
		</div>				
		<div class="pad-left smallnote">
			<ul class="list-unstyled">
						
				
						
				
						
				
						
				
						
				
						
				
						
				
						
				
						
				
						
				
						
				
						
				
				<div class="smallspacer"></div>
				<li> 
					<a class="off" href="/tutorials/baltic/">
					<i class="fa fa-folder-open-o"></i>  / 
					</a> 
				</li>					
				
						
				
						
				
						
				
			
			</ul>			
		</div>	
		<div class="spacer"></div>		
		
		
	</div>
	<div class="col-md-8">				
		<div class="post">
			<p>
			<h2>BALTIC: the Backronymed Adaptable Lightweight Tree Import Code</h2>

<p>baltic was initially developed to extract various statistics from molecular phylogenies derived from <a href="https://github.com/beast-dev/beast-mcmc">BEAST</a> in a customised way. My <a href="dx.doi.org/10.1093/molbev/msu287">influenza B virus reassortment paper</a> used early versions of baltic’s code to look at how the human influenza B virus segment diversity is structured according to genomic background. I’ve since split up the various bits of code into three parts:</p>

<hr>

<h2>baltic</h2>

<p><a href="baltic.py"><code>baltic.py</code></a> is the tree parser itself. It uses three main classes - node, leaf and tree to import, manipulate and plot BEAST trees with their rich variety of comments. Node and leaf classes have references to the usual set of parameters you would find in a phylogeny - index of character in string designating the branch (a unique identifier within the tree), length, height, position in time (absoluteTime), X and Y coordinates, a dictionary encoding BEAST branch comments (traits) and a reference to their parent (None for root) and a string designating their type (branchType). The node class additionally have a children attribute, which is a list of the node’s children, another list called leaves that contains tip names that descend from that node, a numChildren attribute, which is the length of the leaves list and a childHeight attribute which tracks when the last tip descending from the node existed. The leaf class has two extra attributes called name and numName. Trees drawn from the posterior distribution will usually encode tips as numbers to save space and require a translation map to convert back into actual interpretable tip names. In baltic numName will be the exact name for the tip that was used in the tree string, with functions to allow the translation of numName into name.</p>

<p>baltic.py evolved from a <a href="http://stackoverflow.com/questions/280243/python-linked-list/280286#280286">short linked list script on StackOverflow</a> and underwent a major overhaul in order to correct <a href="dx.doi.org/10.1126/science.aaa5646">an article</a> that was wrong. The code should be fairly legible (and commented) and highly adaptable to suit anyone’s needs.</p>

<hr>

<h2>Usage basics</h2>

<p>By convention baltic is imported as bt:</p>

<p><code>import baltic as bt</code></p>

<p>For every tree that we want to import we need an empty tree object:</p>

<p><code>myTree = bt.tree()</code></p>

<p>Then call the <code>make_tree()</code> function with the tree string and the empty container:
```python
treeString=&#39;((A:1.0,B:2.0):1.0,C:3.0);&#39;</p>

<p>bt.make_tree(treeString, myTree)
```
Note it means that you&#39;ll have to write some code to parse out the tree string if you&#39;re not dealing with a newick file. baltic will warn the user if it can&#39;t parse something. If this happens you should check if your tip names or annotations contain characters that should <strong>never</strong> be found outside of functional tree string bits, such as commas or parentheses. Alternatively, it may be that the regexes that are used to parse out tip names or annotations don&#39;t cover some special character you use to define your taxa and will require some editing of baltic.py to alleviate the problem. Feel free to raise an issue if this happens.</p>

<p><code>make_tree()</code> is a function that parses the tree string and interacts with the tree class to build the data structure that is the phylogenetic tree. It works in the following way:</p>

<ul>
<li><p>Every time an opening parenthesis (<code>(</code>) is encountered in the tree string a new instance of <code>node</code> class is created. The new class&#39; <code>.index</code> attribute is set to the index along the tree string where it was encountered, giving that particular class a unique identifier within the tree string. The <code>.parent</code> attribute is set to whatever the previous object encountered was, similarly, since the last encountered object could only be another node, the current node is added to its parents list of children. Finally we set our new node as the &#39;current&#39; node of the tree and append the node to the list of objects (<code>.Objects</code>, which are branches) contained in the tree.</p></li>
<li><p>Every time a string is encountered which may or may not be surrounded by quotation marks (<code>&#39;</code> or <code>&quot;</code>) or have the beginning of an annotation block (<code>[</code>) we create a new <code>leaf</code> class. It also receives an <code>.index</code> identifier, like the <code>node</code> class. Unlike the <code>node</code> class, however, the <code>.numName</code> attribute is also set as the string that defined the tip. In BEAST trees it will be the number that identifies the tip, but it could also be a regular string.</p></li>
<li><p>Next baltic looks for annotations, which are the blocks in the format <code>[&amp;parameter1=1.0,parameter2=0.0]</code>. These are transformed into the <code>.traits</code> dictionary for the branch. In this example the branch being parsed would receive a dictionary with two keys: <code>cur_branch.traits[&#39;parameter1&#39;]=1.0</code> and <code>cur_branch.traits[&#39;parameter2&#39;]=0.0</code>.</p></li>
<li><p>Annotations should be followed by branch lengths preceded by a colon (<code>:</code>). The branch length is assigned to the current branch&#39;s <code>.length</code> attribute.</p></li>
<li><p>Forks in the tree string are defined as commas (<code>,</code>) and ends of clades are defined by closing parentheses (<code>)</code>) and both mean that whatever comes next is in relation to the parent branch of whatever branch we were dealing with earlier.</p></li>
<li><p>Finally tree strings are finished with a semi colon (<code>;</code>).</p></li>
</ul>

<p>Before you can run any analysis you will usually have to traverse the tree such that branch lengths which are available in the tree string are transformed into branch heights:</p>

<p><code>myTree.traverse_tree()</code></p>

<p>This takes the <code>.length</code> attributes of each branch and sums or subtracts them, as appropriate during a tree traversal and the <code>.height</code> attribute of each branch (<code>node</code> or <code>leaf</code> object) is set, where the root of the tree has <code>.height = 0.0</code> and the most recent tip is the highest object in the tree. The tree traversal will also set the tree&#39;s <code>.treeHeight</code> attribute.</p>

<p>If your tree happens to have branch lengths in units of time you can use the <code>.height</code> attribute to modify the <code>.absoluteTime</code> attribute of each branch, such that the entire tree is calibrated and position correctly in time. This involves finding the most recent tip in the tree (in absolute time), subtracting the <code>.treeHeight</code> and adding the <code>.height</code> of the each branch.</p>

<p>Most analytic operations will involve looking at each branch individually without referring back to the tree structure much, beyond immediate children or parents of a particular branch. This is done by iterating over the tree&#39;s <code>.Objects</code> list, which contains all the branches in the tree. If you want to print out the height of each internal branch whose parent had a different trait value you would do it as:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">myTree</span><span class="o">.</span><span class="n">Objects</span><span class="p">:</span>
   <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">bt</span><span class="o">.</span><span class="n">node</span><span class="p">)</span> <span class="c">## (or, alternatively if k.branchType=='node')</span>
       <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">traits</span><span class="p">[</span><span class="n">myTrait</span><span class="p">]</span> <span class="o">!=</span> <span class="n">k</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">traits</span><span class="p">[</span><span class="n">myTrait</span><span class="p">]:</span>
           <span class="k">print</span> <span class="n">k</span><span class="o">.</span><span class="n">height</span>
</code></pre></div>
<hr>

<h2>samogitia</h2>

<p><img src="figures/coa_samogitia.jpg" alt=""></p>

<p><a href="samogitia.py"><code>samogitia.py</code></a> is the heavy-lifting, tree file-wrangling script in the collection. It’s main role is to parse BEAST tree files, use baltic to create tree data structures, which samogitia then manipulates to create BEAST-like log files that can usually be imported into <a href="http://tree.bio.ed.ac.uk/software/tracer/">Tracer</a> or used in another program.</p>

<hr>

<h2>austechia</h2>

<p><img src="figures/coa_austechia.png" alt=""></p>

<p><a href="austechia.ipynb"><code>austechia.ipynb</code></a> is the fancy Jupyter notebook that takes tree files, usually MCC trees from BEAST, and plots them. It is meant to be part teaching tool to get people to think about how trees are plotted, to allow for highly customisable representations of trees (e.g. Fig 6 in my <a href="http://dx.doi.org/10.1093/ve/vev023">MERS-CoV paper</a>) and to improve the aesthetics situation in phylogenetics.</p>

<hr>

<p>Copyright 2016 <a href="https://twitter.com/evogytis">Gytis Dudas</a>. Licensed under a <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p>

		</div>
	</div>			
	<div class="col-md-1"></div>
</div>


	
	</div>
	
	<div id="footer"><span style="display:none">foo</span></div>
		
</body>
</html>

